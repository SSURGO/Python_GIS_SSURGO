---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Steps for processing WI LiDAR data

```{r}
options(stringsAsFactors = FALSE)

library(gdalUtils)
library(rgdal)
library(raster)
library(sf)
library(FedData)

gdal_setInstallation(search_path="C:/Program Files/QGIS 3.2/bin")

setwd("M:/geodata/elevation/lidar/wi")
file_path <- paste0(getwd(), "/")

dems_wi <- list.files(path = "M:/geodata/elevation/lidar/wi", pattern = ".tif$")
dems_wi <- dems_wi[!grepl("0m_|10m_|10m2_|nlcd", dems_wi)]
dems <- data.frame(
  old  = dems_wi, 
  new1 = gsub(".m_wi|.ft_wi", "0m_wi", dems_wi), 
  new2 = gsub(".m_wi|.ft_wi", "10m_wi", dems_wi),
  new3 = gsub(".m_wi|.ft_wi", "10m2_wi", dems_wi),
  areasymbol = sapply(dems_wi, function(x) strsplit(x, "_")[[1]][3]),
  units      = ifelse(grepl("ft_wi", dems_wi), "ft", "m"),
  row.names  = 1:length(dems_wi),
  stringsAsFactors = FALSE
  )
dems$areasymbol <- gsub(".tif", "", dems$areasymbol)


# no translation for Lambert_Conformal_Conic to PROJ.$ is known for the following files, must do manually with ArcGIS
files <- list.files()
f_sub <- files[!grepl("0m_", files)]
idx <- which(! dems$new1 %in% f_sub)
print(dems[idx,])

idx <- which(dems$areasymbol %in% c("wi021", "wi023", "wi079"))


# Setup output extent to match nlcd layer
sso_pol <- read_sf(dsn = "D:/geodata/soils/SSURGO_R11_FY17.gdb", layer = "SAPOLYGON")
st_crs(sso_pol) <- "+init=epsg:5070"
sso_wi <- sso_pol[grepl("WI", sso_pol$AREASYMBOL), ]
bb <- st_bbox(sso_wi)

gdal_translate(
  src_dataset = "M:/geodata/land_use_land_cover/nlcd_2011_landcover_2011_edition_2014_03_31.img",
  dst_dataset = "nlcd_wi.tif",
  a_srs = "+init=epsg:5070",
  projwin = c(bb[1], bb[4], bb[3], bb[2]),
  of = "GTiff",
  a_nodata = -99999,
  overwrite = TRUE,
  verbose = TRUE
  )


# reproject lidar to EPSG:5070
split(dems, dems$old) ->.;
lapply(., function(dems){
  cat(dems$new1, format(Sys.time(), "%Y-%m-%d %H:%M:%S"), "\n")
  
  nlcd = paste0("nlcd_", dems$new1)
  bb   = bbox(raster(dems$new1))
  
  gdal_translate(
    src_dataset = "nlcd_wi.tif",
    dst_dataset = nlcd,
    a_srs = crsarg,
    projwin = bb[c(1, 4, 3, 2)],
    of = "GTiff",
    a_nodata = -99999,
    overwrite = TRUE,
    verbose = TRUE
    )
  
  te =  c(bbox(raster(nlcd)))
  
  gdalwarp(
    srcfile = dems$old,
    dstfile = dems$new1,
    t_srs = "+init=epsg:5070",
    te = te,
    r = "bilinear",
    of = "GTiff",
    dstnodata = "-99999",
    verbose = TRUE,
    overwrite = TRUE
    )
  })


# resample lidar to 10-meters
split(dems, dems$old) ->.;
lapply(., function(dems){
  
  cat(dems$new1, format(Sys.time(), "%Y-%m-%d %H:%M:%S"), "\n")
  
  gdalwarp(
    srcfile = dems$new1,
    dstfile = dems$new2,
    t_srs = "+init=epsg:5070",
    r = "average",
    tr = c(10, 10),
    #te = te,
    of = "GTiff",
    dstnodata = "-99999",
    verbose = TRUE,
    overwrite = TRUE
    )
  })


# convert feet to meters
split(dems, dems$old) ->.;
lapply(., function(dems) {
  
  cat(dems$new2, format(Sys.time(), "%Y-%m-%d %H:%M:%S"), "\n")
  
  test  = raster(dems$new2)
  
  if (dems$units == "ft") {
    test2 = calc(test, function(x) x * 0.3048, progress = "text")
  } else test2 = calc(test, function(x) x * 1, progress = "text")
  
  crs(test2) <- "+init=epsg:5070"
  
  writeRaster(test2, filename = dems$new3, overwrite = TRUE, progress = "text")
  })


# doesn't work well with this data, use gdalwarp and cblend argument
test <- do.call(mosaic, lapply(dems$new3, raster))

mosaic_rasters(
  gdalfile = dems$new3,
  dst_dataset = "lidar10m_wi_noSmoothing.tif",
  of = "GTiff",
  vrtnodata = "-99999",
  verbose = TRUE,
  overwrite = TRUE
  )

gdaldem(
  mode = "hillshade",
  input_dem = "lidar10m_wi_noSmoothing.tif",
  output = "lidar10m_wi_noSmoothing_hs.tif",
  verbose = TRUE
  )


# Setup output extent to match nlcd layer
sso_pol <- read_sf(dsn = "D:/geodata/soils/SSURGO_R11_FY17.gdb", layer = "SAPOLYGON")
st_crs(sso_pol) <- "+init=epsg:5070"
sso_wi <- sso_pol[grepl("WI", sso_pol$AREASYMBOL), ]
bb <- st_bbox(sso_wi)

nlcd <- "M:/geodata/land_use_land_cover/nlcd_2011_landcover_2011_edition_2014_03_31.img"

te <-  c(bbox(raster("nlcd_wi.tif")))


gdalwarp(
  srcfile = c("D:/geodata/project_data/R11-JUE/ned10m_R11-JUE.tif", dems$new3),
  dstfile = "lidarNed10m_R11-JUE.tif",
  cutline = "D:/geodata/project_data/R11-JUE/RTSD_R11JUE_FY17.gdb",
  te = te,
  cl = "SAPOLYGON",
  cblend = 10,
  overwrite = TRUE,
  verbose = TRUE
  )

```

